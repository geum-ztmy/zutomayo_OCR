<html>

<head>
  <title>zutomayo_OCR</title>
  <meta charset="utf-8">
  <script src="https://unpkg.com/tesseract.js@2.0.0-beta.1/dist/tesseract.min.js"></script>
  <meta name="viewport"
    content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no, shrink-to-fit=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="stylesheet" href="./index.css" />
  <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>

  <script>
    const { createWorker } = Tesseract;
    const worker = createWorker({
      langPath: './',
      gzip: false,
    });
    //æœ€åˆã«èª­ã¿è¾¼ã‚€ã¨ã„ã„ã‚‰ã—ã„?
    (async () => {
      await worker.load();
      await worker.loadLanguage('ztmy');
      await worker.initialize('ztmy');
      var result = await worker.recognize('./sample.png')
      $("#status").text('æº–å‚™å®Œäº†')
      console.log(result.data.text);
      await worker.terminate();
    })();
  </script>
</head>



<body>
  <div align="center">

    <!-- ã‚ãŸã¾ã®ã¨ã“ã‚ -->
    <img id="demo_img" src="./sample.png" />
    <br><br>

    <div id="video-container">
      <!-- ã³ã§ãŠ(å®Ÿã¯ã‚ã£ã£ã¡ã‚ƒã¡ã£ã¡ã‚ƒã„ã®ãŒéš ã‚Œã¦ã‚‹) -->
      <video id="player" muted autoplay playsinline></video>
      <canvas id="canvas" width="300" height="100"></canvas>
    </div>

    <div>
      <button class="button" id="capture"> ã‚«ãƒ¡ãƒ©èªè­˜ï¼ </button>
    </div>
    <br>
    <div>
      <input type="file" id="file-input">
    </div>
    <div>
      <button class="button" id="ocr-button"> ç”»åƒèªè­˜ï¼ </button>
    </div>
    <div>
      <p>status:<span id="status">æº–å‚™ä¸­</span></p>
    </div>




    <br>
    <!-- ã‘ã£ã‹ã®ã¨ã“ã‚ -->
    <div id="results" align="center"></div>
    <canvas id="snapshot" width="300" height="100"></canvas>
    <br>
    <br>
    <br>
    <br>
    <br>



    <script>

      var video = document.getElementById("player"),
        canvas = document.getElementById("canvas"),
        ctx = canvas.getContext("2d");

      video.autoplay = true;
      video.muted = true;
      video.playsInline = true;
      canvas.width = 300;
      canvas.height = 100;

      requestAnimationFrame(draw);

      function draw() {
        ctx.drawImage(video, 100, 300, 600, 200,
          0, 0, 300, 100);
        imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        data = imgData.data;
        for (let i = 0; i < data.length; i += 4) {
          ave = (data[i + 0] + data[i + 1] + data[i + 2]) / 3;
          data[i + 0] =
            data[i + 1] =
            data[i + 2] = (ave > 128) ? 255 : 0;
          data[i + 3] = 255;
        }
        ctx.putImageData(imgData, 0, 0);
        requestAnimationFrame(draw);
      }



      //ãƒ“ãƒ‡ã‚ªã¨ã‹ã®è¨­å®š(ä¿ºã‚‚ã‚ˆãã‚ã‹ã‚‰ã‚“)
      const snapshotCanvas = document.getElementById('snapshot');
      const captureButton = document.getElementById('capture');

      const handleSuccess = function (stream) {
        video.srcObject = stream;
        video.play();
      };

      const handleError = function (error) {
        const captureButton = document.getElementById("capture");
        captureButton.disabled = true;
      
        const videoContainer = document.getElementById("video-container");
        const messages = ["ã‚«ãƒ¡ãƒ©ãŒä½¿ãˆãªã„ã‚ˆğŸ¥¹"];
        if (error.name === "NotAllowedError") {
          messages.push("ã‚«ãƒ¡ãƒ©ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã—ã¦ã­");
        }
      
        const errorMessage = `
          <div class="error-message">
            <p>
              ${messages.join("<br />")}
            </p>
          </div>
        `;
        videoContainer.insertAdjacentHTML("beforeend", errorMessage);

        console.error('navigator.getUserMedia error: ', error);
      };

      const constraints = {
        audio: false,
        video: {
          width: 1920,
          height: 1080,
          facingMode: 'environment'
        }
      };

      navigator.mediaDevices.getUserMedia(constraints)
        .then(handleSuccess)
        .catch(handleError);




      var num = 1;




      //èªè­˜ï¼
      captureButton.addEventListener('click', async function () {
        $("#status").text('èªè­˜ä¸­....')
        var context = snapshot.getContext('2d');
        context.drawImage(video, 100, 300, 600, 200, 0, 0, snapshotCanvas.width,
          snapshotCanvas.height);
        const url = snapshot.toDataURL("image/png");

        const { createWorker } = Tesseract;
        const worker = createWorker({
          langPath: './',
          gzip: false,
        });

        (async () => {
          await worker.load();
          await worker.loadLanguage('ztmy');
          await worker.initialize('ztmy');
          var result = await worker.recognize(url)
          console.log(result);
          var elem = document.createElement('div');
          elem.innerHTML = "<div id=" + num + " style='width:300px; background-color:rgb(215,213,207)'><img src=" + url + " /></div><br>"
          var parent = document.getElementById("results");
          parent.insertBefore(elem, parent.firstChild);
          var numdiv = document.getElementById(num);
          var msg = document.createElement('div');
          msg.innerHTML = result.data.text;
          numdiv.appendChild(msg);
          num += 1;

          $("#status").text('å‡¦ç†å®Œäº†');

          await worker.terminate();
        })();
      });



      //ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼
      const fileInput = document.getElementById('file-input');
      fileInput.type = 'file';
      fileInput.addEventListener('change', function () {
        const file = fileInput.files[0];
        $("#status").text('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†');
      });


      //ç”»åƒèªè­˜ï¼
      const ocrButton = document.getElementById('ocr-button');
      ocrButton.addEventListener('click', function () {
        if (!fileInput.files[0]) {
          $("#status").text('ã‚ã£ã·ã‚ãƒ¼ã©ã—ã¦ã­');
          return;
        }
        tryOcr().then(() => {
          // OCRãŒå®Œäº†
          $("#status").text('å‡¦ç†å®Œäº†')
        });
      });

      const tryOcr = async () => {
        $("#status").text('èªè­˜ä¸­......')
        const { createWorker } = Tesseract;
        const worker = createWorker({
          langPath: './',
          gzip: false,
          //logger: m => console.log(m)
        });

        await worker.load();
        await worker.loadLanguage('ztmy');
        await worker.initialize('ztmy');
        var result = await worker.recognize(fileInput.files[0])

        console.log(result);
        //$("#res_tx").text(result.data.text)
        var elem = document.createElement('div');

        // Blob URLã‚’ä½œæˆã™ã‚‹
        const imageUrl = URL.createObjectURL(fileInput.files[0]);

        elem.innerHTML = "<div id=" + num + " style='width:300px; background-color:rgb(215,213,207)'><img src=" + imageUrl + " width='300'; height='100'  /></div><br>"

        var parent = document.getElementById("results");
        parent.insertBefore(elem, parent.firstChild);
        var numdiv = document.getElementById(num);
        var msg = document.createElement('div');
        msg.innerHTML = result.data.text;
        numdiv.appendChild(msg);
        num += 1;

        await worker.terminate();
      }


    </script>

  </div>

</body>

</html>
